# 聊天页面测试规格

## 能力概述

增强聊天页面（`src/pages/Chat/`）的单元测试覆盖，包括主页面组件、聊天列表侧边栏、聊天内容区以及流式消息接收、错误处理和推理内容显示等核心用户交互流程。

## 需求

### 功能需求

**REQ-1: 聊天页面主组件**
- 组件应正确渲染聊天列表侧边栏和聊天内容区
- 应支持侧边栏的展开/收起状态
- 应处理 URL 参数中的 `chatId` 并验证聊天是否存在
- 应在聊天不存在时重定向到 `/chat` 页面

**REQ-2: 聊天列表侧边栏（ChatSidebar）**
- 应显示所有未删除的聊天列表
- 应提供新建聊天按钮
- 应支持搜索过滤聊天
- 应支持选择聊天项
- 应支持删除聊天项
- 应显示聊天的最后消息预览
- 应按时间戳排序聊天列表

**REQ-3: 聊天内容区（ChatContent）**
- 应显示当前聊天的所有消息
- 应支持流式消息接收和渲染
- 应显示推理内容（reasoning content）
- 应支持消息重试功能
- 应显示错误状态和错误提示
- 应支持复制消息内容
- 应支持重新生成消息

**REQ-4: 流式消息接收**
- 应正确处理流式响应的分块数据
- 应实时更新消息内容
- 应显示流式接收中的加载状态
- 应处理流式连接中断或错误

**REQ-5: 错误处理**
- 应显示网络错误提示
- 应显示 API 错误提示
- 应提供重试按钮
- 应处理超时错误

**REQ-6: 推理内容显示**
- 应支持显示模型的推理过程（reasoning content）
- 应能够展开/收起推理内容
- 应区分推理内容和最终回复的样式

### 测试覆盖需求

**TEST-1: ChatPage 主组件测试（已存在，需增强）**
- ✅ 聊天不存在时重定向（已存在）
- ✅ 聊天存在时正常加载（已存在）
- ✅ 聊天已删除时重定向（已存在）
- ✅ 无 chatId 时不重定向（已存在）
- ✅ 聊天列表加载期间等待（已存在）
- ✅ 防止重定向循环（已存在）
- ✅ 聊天列表加载失败时不检查（已存在）
- 🆕 测试侧边栏折叠状态切换
- 🆕 测试侧边栏折叠状态的持久化

**TEST-2: ChatSidebar 组件测试（新增）**
- 测试渲染聊天列表
- 测试显示空列表状态
- 测试新建聊天按钮
- 测试搜索过滤功能
- 测试选择聊天项
- 测试删除聊天项
- 测试聊天列表排序
- 测试最后消息预览显示
- 测试删除确认对话框

**TEST-3: ChatContent 组件测试（新增）**
- 测试渲染消息列表
- 测试显示空聊天状态
- 测试用户消息和助手消息的样式区分
- 测试消息时间戳显示
- 测试消息内容 Markdown 渲染
- 测试代码块语法高亮

**TEST-4: 流式消息接收测试（新增）**
- 测试流式消息的逐步更新
- 测试流式消息完成状态
- 测试流式消息错误处理
- 测试流式中断恢复
- 测试流式消息的 Token 计数显示

**TEST-5: 错误处理测试（新增）**
- 测试网络错误显示
- 测试 API 错误显示
- 测试重试按钮功能
- 测试超时错误处理
- 测试错误状态的清除

**TEST-6: 推理内容显示测试（新增）**
- 测试推理内容的展开/收起
- 测试推理内容和最终回复的样式区分
- 测试推理内容的 Markdown 渲染
- 测试推理内容中的代码块显示
- 测试无推理内容时不显示推理区域

### 质量需求

- **代码覆盖率**：聊天页面相关组件的语句覆盖率 ≥ 60%
- **测试可靠性**：所有测试应独立运行，不依赖执行顺序
- **Mock 策略**：
  - Mock 所有 `@ant-design/x` 组件以避免 ES 模块兼容性问题
  - Mock React Router hooks 和自定义 hooks
  - Mock Redux store 和 actions
- **测试速度**：每个测试用例执行时间 < 200ms（流式测试除外）

## 依赖

- **React Testing Library**: 用于组件渲染和交互测试
- **Vitest**: 测试运行器
- **项目测试辅助工具**：`@/test-helpers` 中的 mock 工厂和辅助函数
- **现有测试文件**：`src/__test__/pages/Chat/ChatPage.test.tsx`（7 个测试）

## 成功标准

- 所有测试用例通过（包括现有的 7 个测试）
- 新增 30-40 个测试用例
- 代码覆盖率达到目标（≥ 60%）
- 测试文件位于 `src/__test__/pages/Chat/` 目录
- 测试不产生控制台错误或警告
- Mock 策略正确，不触发 antd ES 模块问题
