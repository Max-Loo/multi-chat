# E2E 测试能力规格

## ADDED Requirements

### Requirement: 支持端到端测试能力

系统必须提供端到端（E2E）测试能力，以验证核心用户流程的完整性和稳定性。E2E 测试应该覆盖聊天发送、模型管理、应用初始化三个核心流程，并支持在本地开发环境中快速运行。

该能力使用 Playwright 作为测试框架，通过页面对象模型封装页面交互，使用工厂函数管理测试数据，并提供测试辅助工具以降低测试编写和维护成本。

---

### Requirement: 聊天发送流程测试

系统必须提供自动化测试，验证用户创建聊天、选择模型、发送消息、接收响应、保存历史的完整流程。

#### Scenario: 创建新聊天并发送消息

- **WHEN** 用户打开聊天页面
- **AND** 点击"创建新聊天"按钮
- **AND** 从模型列表中选择一个可用模型
- **AND** 在消息输入框中输入文本"Hello, this is a test message"
- **AND** 点击"发送"按钮
- **THEN** 系统应该将消息添加到聊天历史记录
- **AND** 在聊天界面显示用户消息
- **AND** 显示"正在输入"或类似的加载状态
- **AND** 在 30 秒内收到 AI 模型的响应
- **AND** 响应消息显示在聊天界面中
- **AND** 响应内容不是空值或错误信息

#### Scenario: 流式响应实时更新

- **WHEN** 用户发送一条需要较长响应的消息（如"请详细解释量子计算"）
- **AND** AI 模型开始返回流式响应
- **THEN** 系统应该实时显示响应内容
- **AND** 响应内容逐渐增长（不是一次性显示）
- **AND** 响应完成后停止更新
- **AND** 最终的响应内容完整且格式正确

#### Scenario: 聊天历史持久化

- **WHEN** 用户创建一个聊天并发送多条消息
- **AND** 刷新页面或重启应用
- **AND** 重新打开同一个聊天（通过聊天 ID）
- **THEN** 系统应该加载并显示所有历史消息
- **AND** 消息顺序正确（用户消息和 AI 响应对应）
- **AND** 消息内容完整无缺失
- **AND** 选择的模型信息保持一致

#### Scenario: 切换聊天

- **WHEN** 用户在聊天 A 中发送了消息
- **AND** 创建新聊天 B 并发送不同的消息
- **AND** 切换回聊天 A
- **THEN** 系统应该显示聊天 A 的完整历史
- **AND** 不显示聊天 B 的消息
- **AND** 切换回聊天 B 时正确显示其历史

#### Scenario: 空输入验证

- **WHEN** 用户在消息输入框中只输入空格或留空
- **AND** 点击"发送"按钮
- **THEN** 系统应该不发送消息
- **AND** 可能显示提示"请输入消息"
- **AND** 聊天历史不变

---

### Requirement: 模型管理流程测试

系统必须提供自动化测试，验证用户添加模型、配置 API Key、编辑模型、删除模型的完整流程。

#### Scenario: 添加新模型

- **WHEN** 用户导航到模型管理页面
- **AND** 点击"添加模型"按钮
- **AND** 系统跳转到模型配置表单页面
- **AND** 填写表单：
  - 昵称："Test Model"
  - API Key："sk-test-123456"
  - API 地址："https://api.test.com/v1"
  - 模型名称："test-model"
  - 选择供应商："Test Provider"
- **AND** 点击"提交"按钮
- **THEN** 系统应该保存模型配置
- **AND** 跳转回模型列表页面
- **AND** 新创建的模型显示在列表中
- **AND** 模型信息（昵称、供应商）正确显示

#### Scenario: 编辑现有模型

- **WHEN** 用户在模型列表中点击某个模型的"编辑"按钮
- **AND** 修改模型的昵称
- **AND** 修改 API Key
- **AND** 点击"保存"按钮
- **THEN** 系统应该更新模型配置
- **AND** 返回模型列表页面
- **AND** 修改后的信息正确显示
- **AND** 原有的聊天历史仍然可用

#### Scenario: 删除模型（软删除）

- **WHEN** 用户在模型列表中点击某个模型的"删除"按钮
- **AND** 确认删除操作
- **THEN** 系统应该将模型标记为已删除（软删除）
- **AND** 该模型不再出现在模型列表中
- **AND** 使用该模型的历史聊天仍然可以查看
- **AND** 但无法继续使用该模型发送新消息

#### Scenario: 表单验证

- **WHEN** 用户在添加模型表单中：
  - 不填写昵称
  - 或不填写 API Key
  - 或不填写 API 地址
- **AND** 点击"提交"按钮
- **THEN** 系统应该显示验证错误提示
- **AND** 不保存模型配置
- **AND** 用户停留在表单页面

#### Scenario: API Key 加密存储

- **WHEN** 用户添加或编辑模型并提供了 API Key
- **AND** 提交表单
- **THEN** 系统应该对 API Key 进行加密存储
- **AND** 不在数据库或存储中以明文形式保存
- **AND** 加密后的 Key 可以正确解密并使用

---

### Requirement: 应用初始化和数据恢复测试

系统必须提供自动化测试，验证应用首次启动的初始化流程，以及重启后数据恢复的能力。

#### Scenario: 首次启动初始化

- **WHEN** 用户首次启动应用（无任何本地数据）
- **THEN** 系统应该显示初始化屏幕或加载指示器
- **AND** 按照依赖关系执行初始化步骤：
  1. 初始化国际化（i18n）
  2. 初始化主密钥（masterKey）
  3. 加载模型数据（依赖 masterKey）
  4. 加载聊天列表
  5. 加载应用语言配置
  6. 加载模型供应商定义
- **AND** 如果所有步骤成功，显示主应用界面
- **AND** 初始化过程在 30 秒内完成

#### Scenario: 初始化失败处理

- **WHEN** 应用初始化过程中某个步骤失败
- **AND** 该步骤被标记为"致命错误"（如 masterKey 初始化）
- **THEN** 系统应该停止初始化
- **AND** 显示错误屏幕，说明错误原因
- **AND** 提供重试或退出选项

- **WHEN** 应用初始化过程中某个步骤失败
- **AND** 该步骤被标记为"警告错误"（如 models 加载）
- **THEN** 系统应该记录错误日志
- **AND** 继续执行后续初始化步骤
- **AND** 显示 Toast 提示告知用户部分功能可能不可用
- **AND** 主应用界面仍然可用

#### Scenario: 数据持久化验证

- **WHEN** 用户创建了一个聊天并发送了消息
- **AND** 添加了一个模型配置
- **AND** 修改了应用设置（如语言）
- **AND** 关闭应用
- **AND** 重新启动应用
- **THEN** 系统应该恢复所有用户数据：
  - 聊天列表完整
  - 聊天历史记录完整
  - 模型配置完整
  - 应用设置保持用户选择的值

#### Scenario: 主密钥丢失后的降级处理

- **WHEN** 用户之前使用加密功能存储了数据
- **AND** 主密钥丢失或损坏
- **AND** 用户重新启动应用
- **THEN** 系统应该检测到主密钥不可用
- **AND** 显示友好的错误提示
- **AND** 将加密的 API Key 显示为空字符串
- **AND** 允许用户重新配置模型
- **AND** 不崩溃或进入无限循环

---

### Requirement: 测试基础设施要求

系统必须提供测试基础设施，以支持快速、稳定、可维护的 E2E 测试。

#### Scenario: 页面对象模型封装

- **WHEN** 测试代码需要与页面交互
- **THEN** 系统应该提供页面对象类封装页面操作
- **AND** 页面对象包含方法：
  - `goto()`: 导航到页面
  - `waitForReady()`: 等待页面加载完成
  - 业务操作方法（如 `createNewChat()`, `sendMessage()`）
- **AND** 测试代码通过页面对象方法交互，而非直接操作 DOM
- **AND** 页面对象隐藏定位器实现细节

#### Scenario: 测试数据隔离

- **WHEN** 多个测试依次运行
- **THEN** 每个测试应该使用独立的测试数据
- **AND** 测试之间不共享状态
- **AND** 每个测试后清理测试数据
- **AND** 测试数据不影响开发环境数据

#### Scenario: 稳定的定位器策略

- **WHEN** 测试需要定位页面元素
- **THEN** 优先使用 `data-testid` 属性定位器
- **OR** 使用语义化定位器（getByRole, getByText）
- **AND** 避免使用 CSS 类名或 XPath
- **AND** 定位器在 UI 样式变更时仍然有效

#### Scenario: 快速测试执行

- **WHEN** 开发者运行冒烟测试（@smoke 标签）
- **THEN** 测试套件应该在 1 分钟内完成
- **AND** 提供清晰的测试结果报告
- **AND** 失败的测试显示详细的错误信息和截图

#### Scenario: AI 辅助测试生成

- **WHEN** 开发者需要创建新的测试
- **THEN** 系统应该支持使用 playwright-cli 探索基础交互（可选）
- **AND** playwright-cli 提供交互式浏览器控制和智能快照功能
- **AND** 支持 AI coding agents 根据场景描述直接生成测试代码
- **AND** AI Agent 可利用 playwright-cli 快照信息生成更准确的代码
- **AND** 生成的代码遵循页面对象模型和定位器策略
- **AND** 生成的代码包含必要的断言和错误处理

**可选：playwright-cli 探索工作流**：
1. 使用 `playwright-cli open http://localhost:1420` 打开浏览器
2. 执行 UI 操作（点击、输入、导航等）
3. 使用 `playwright-cli snapshot` 保存快照
4. 将快照信息提供给 AI Agent
5. AI Agent 基于快照和场景描述生成测试代码
6. 运行测试验证

---

### Requirement: 测试环境配置要求

系统必须提供测试环境配置，确保测试在隔离、可重复的环境中运行。

#### Scenario: Web 模式测试运行

- **WHEN** 运行 E2E 测试
- **THEN** 系统应该启动 Web 版本的应用（`pnpm web:dev`）
- **AND** 应用运行在 localhost:1420
- **AND** 测试在 Chromium 浏览器中执行
- **AND** 测试可以使用 Playwright 的所有调试功能

#### Scenario: 测试超时和重试配置

- **WHEN** 测试执行时间超过默认超时时间
- **THEN** 系统应该在 30 秒后超时并标记测试失败
- **AND** 自动重试失败的测试最多 2 次
- **AND** 只有重试都失败后才最终标记为失败

#### Scenario: 测试报告和调试信息

- **WHEN** 测试完成（无论成功或失败）
- **THEN** 系统应该生成 HTML 测试报告
- **AND** 失败的测试保存截图
- **AND** 失败的测试保存 trace 文件（包含网络请求、控制台日志）
- **AND** 提供命令快速查看报告（`pnpm test:e2e:report`）

---

### Requirement: 组件可测试性要求

系统必须确保关键 UI 组件具备可测试性，以支持 E2E 测试定位和交互。

#### Scenario: 关键元素标识

- **WHEN** 测试需要定位关键 UI 元素
- **THEN** 以下元素应该具有 `data-testid` 属性：
  - 主要导航按钮（创建聊天、模型管理、设置）
  - 表单输入框（消息输入、模型配置表单）
  - 操作按钮（发送、提交、删除、编辑）
  - 状态指示器（加载状态、错误提示）
  - 聊天消息气泡（用户消息、AI 响应）
  - 模型列表项
- **AND** `data-testid` 值使用 kebab-case 命名
- **AND** `data-testid` 值语义化且唯一

#### Scenario: 可访问性支持

- **WHEN** 测试使用语义化定位器（getByRole）
- **THEN** 关键交互元素应该具有正确的 ARIA 属性：
  - 按钮有 `role="button"`
  - 输入框有关联的 `label`
  - 对话框有 `role="dialog"`
  - 加载状态有 `aria-busy="true"`
- **AND** 测试可以通过角色和名称定位元素

---

## Non-Functional Requirements

### Requirement: 测试性能要求

- E2E 测试套件总执行时间不应超过 5 分钟
- 单个测试用例执行时间不应超过 60 秒（调整后）
- 冒烟测试（@smoke）应在 3 分钟内完成（调整后）

### Requirement: 测试稳定性要求

- 测试失败率应低于 5%
- 重复运行同一测试 10 次，至少成功 9 次
- 不应该有不稳定的（flaky）测试

### Requirement: 测试可维护性要求

- 新功能的 E2E 测试编写时间应在 30 分钟内（使用 AI 辅助）
- 页面对象方法复用率应高于 60%
- 测试代码与业务逻辑的耦合度应低于 30%

---

## Testing Strategy

### 测试覆盖策略

**优先级 P0（必须覆盖）**：
- ✅ 创建聊天并发送消息的核心流程
- ✅ 添加和配置模型的核心流程
- ✅ 应用首次启动的初始化流程

**优先级 P1（应该覆盖）**：
- ⚠️ 聊天历史持久化
- ⚠️ 编辑和删除模型
- ⚠️ 表单验证
- ⚠️ 错误处理和降级

**优先级 P2（可以覆盖）**：
- 📝 边缘用例（空输入、超长文本）
- 📝 性能相关（大量消息、长时间运行）
- 📝 可访问性验证

### 测试数据策略

- 使用工厂函数生成测试数据
- 每个测试使用独立的测试数据集
- 测试数据包含正常情况和边界情况
- 敏感数据（API Key）使用测试专用值

### 测试环境策略

- 使用 Web 模式运行测试（非 Tauri 模式）
- 使用独立的测试数据存储路径
- 测试前清理环境，测试后验证清理
- 支持本地快速运行和选择性运行

---

## Success Criteria

实施完成后，系统应该满足以下成功标准：

### 量化指标（必须满足）

1. **测试覆盖**：
   - ✅ 至少 3 个核心流程的 E2E 测试通过
   - ✅ 覆盖聊天发送、模型管理、应用初始化
   - ✅ 测试代码覆盖率（分支）> 70%

2. **测试质量**：
   - ✅ 所有测试使用页面对象模型（100% 合规）
   - ✅ 所有测试使用稳定的定位器（data-testid 或语义化）
   - ✅ 测试之间完全隔离，无状态泄漏
   - ✅ 无硬编码等待时间（0 个 `page.waitForTimeout()`）

3. **测试稳定性**：
   - ✅ 测试通过率 = 100%（在 CI 中）
   - ✅ 测试稳定性 ≥ 95%（重复运行 10 次，至少 9 次成功）
   - ✅ 无 flaky tests（不稳定的测试）

4. **开发效率**：
   - ✅ 新测试编写时间 < 1 小时（使用 AI 辅助）
   - ✅ 冒烟测试运行时间 < 3 分钟（调整后的目标）
   - ✅ 单个测试执行时间 < 60 秒（调整后的目标）

5. **代码质量**：
   - ✅ 所有 ESLint 规则通过
   - ✅ 所有 AI 生成代码通过质量 checklist
   - ✅ 页面对象方法复用率 > 60%
   - ✅ 测试代码与业务逻辑耦合度 < 30%

### 质量指标（应该满足）

6. **可维护性**：
   - ✅ 测试代码清晰易读
   - ✅ 页面对象模型良好封装
   - ✅ 测试数据集中管理（工厂函数）
   - ✅ Mock API 函数易于使用

7. **文档完善**：
   - ✅ README 包含运行和编写指南
   - ✅ 代码规范清晰明确
   - ✅ AI 生成代码质量 Checklist 完善
   - ✅ 示例代码可用（templates/ 和 examples/）

### 验证方法

**自动化验证**：
```bash
# 1. 运行所有测试
pnpm test:e2e

# 2. 运行冒烟测试并计时
time pnpm test:e2e:smoke

# 3. 检查 ESLint
pnpm lint e2e/

# 4. 稳定性测试（重复 10 次）
for i in {1..10}; do pnpm test:e2e:smoke || exit 1; done
```

**人工验证**：
- 代码审查是否符合页面对象模型
- 检查定位器是否稳定
- 检查是否有硬编码等待
- 评估文档是否完整
