# 设计文档：AGENTS.md 精简方案

## 1. 当前问题分析

### 1.1 文档规模问题

- **当前行数**：1316 行
- **主要问题**：
  - 大量详细的代码示例（可在源文件中查看）
  - 重复的内容说明（HTTP 插件兼容层有 3 段重复）
  - 过时的测试统计数据（"2026-03-01 更新"）
  - 可从其他地方查询的信息（package.json、代码文件）

### 1.2 维护成本分析

**重复内容示例**：

```
第 738-791 行：HTTP 插件兼容层说明（第 1 次）
第 798-827 行：HTTP 插件兼容层说明（第 2 次）
第 829-843 行：HTTP 插件兼容层说明（第 3 次）
```

这 3 段内容几乎完全相同，仅在第 2 段有"使用场景示例"，导致：
- 修改时需要同步 3 处
- 容易出现不一致
- 增加文档维护负担

### 1.3 可读性问题

**关键信息被淹没**：
- 开发规范（重要）在 1214-1316 行（文档末尾）
- 测试辅助工具（相对次要）占 59-308 行（250 行）
- 项目架构概述在 5-25 行（容易被忽略）

---

## 2. 精简策略

### 2.1 内容分类

| 类别 | 处理方式 | 示例 |
|------|----------|------|
| **必要信息** | 保留 | 项目架构、开发规范、关键约定 |
| **可查询信息** | 删除，提供文件引用 | Tauri 插件列表 → package.json |
| **详细示例** | 删除，保留简要说明 | API 使用示例 → 指向源文件 |
| **重复内容** | 合并为一段 | HTTP 插件说明（3 段 → 1 段） |
| **过时数据** | 删除 | 测试覆盖率统计 |

### 2.2 保留内容清单

#### ✅ 必须保留

1. **项目概述**（5-8 行）
   - 技术栈：Tauri + React + TypeScript
   - 简短描述

2. **架构说明**（10-12 行）
   - 前端：React 19 + TypeScript + Vite
   - 后端：Rust + Tauri 2.0
   - 通信方式：invoke()

3. **开发命令**（20-25 行）
   - 仅保留常用命令（dev、build、lint、test）
   - 删除不常用命令（analyze:unused 可放在 README.md）

4. **关键设计说明**（80-100 行）
   - **应用启动初始化流程**（20 行）
     - InitializationManager 的作用
     - 初始化步骤列表（简要）
     - 指向 `src/config/initSteps.ts`
   - **远程模型数据获取**（20 行）
     - 架构概览（图示）
     - 关键模块说明（指向文件）
   - **聊天服务层**（20 行）
     - 架构设计（图示）
     - 核心功能概述
     - 指向 `src/services/chatService.ts`
   - **跨平台兼容性**（20 行）
     - 设计原则（Null Object 模式、环境检测）
     - 兼容层目录结构
     - 指向 `src/utils/tauriCompat/`

5. **开发规范**（80-100 行）
   - **导入路径规范**：使用 `@/` 别名
   - **代码文档要求**：JSDoc 格式
   - **代码实现原则**：KISS、YAGNI、DRY、SOLID
   - **注释语言**：中文
   - **回复开场白**："向着星辰和深渊！"
   - **Skill 使用说明**：列举使用的 skill
   - **shadcn/ui 安装**：`pnpm dlx shadcn@latest add xxx`
   - **文档同步要求**：修改代码时检查 AGENTS.md 和 README.md

6. **项目约定**（20-30 行）
   - **时间戳工具函数**：约定和规范
   - 指向 `src/utils/utils.ts`

7. **文档参考**（新增章节，30-40 行）
   - 关键文件路径索引
   - 快速查找指南

#### ❌ 应该删除

1. **详细的代码示例**（约 200 行）
   ```typescript
   // 示例：当前文档中的详细代码
   // 从 src/__test__/utils/tauriCompat/helpers.ts 导入...
   // 模拟 Tauri 环境...
   // （此类示例应删除，指向源文件即可）
   ```

2. **重复的 HTTP 插件说明**（约 100 行）
   - 保留第一段（738-791 行）
   - 删除后两段（798-843 行）

3. **详细的测试覆盖率统计**（约 150 行）
   - 删除具体的测试数字（"745 个测试"、"92.35% 覆盖率"等）
   - 保留测试框架信息（Vitest + React Testing Library）

4. **Tauri 插件列表**（约 10 行）
   - 删除详细列表
   - 添加说明："可在 package.json 中查看"

5. **测试辅助工具详细说明**（约 200 行）
   - 精简为简要列表
   - 指向 `src/__test__/helpers/` 目录

---

## 3. 新文档结构设计

### 3.1 章节组织（按重要性排序）

```markdown
# AGENTS.md

## 0. 文档维护原则（45 行）
   ### 0.1 内容分类规则
       - 必要信息 → 保留
       - 可查询信息 → 删除，提供文件引用
       - 详细示例 → 删除，保留简要说明
       - 重复内容 → 合并为一段
       - 过时数据 → 删除
   ### 0.2 添加新内容检查清单
       - 5 个必答问题
   ### 0.3 优先级原则
       - 代码注释优先 → README.md 次之 → AGENTS.md 最后
   ### 0.4 维护规范
       - 保持精简（目标 350 行以内）
       - 及时更新
       - 定期审查
       - 版本控制
   ### 0.5 当前文档状态
       - 总行数、待优化项、参考方案

## 1. 项目概述（5 行）
   - 技术栈
   - 简短描述

## 2. 架构（10 行）
   - 前端架构
   - 后端架构
   - 通信方式

## 3. 开发命令（20 行）
   - 常用命令列表

## 4. 关键设计说明（80 行）
   ### 4.1 应用启动初始化流程
   ### 4.2 远程模型数据获取
   ### 4.3 聊天服务层
   ### 4.4 跨平台兼容性

## 5. 开发规范（100 行）
   ### 5.1 导入路径规范
   ### 5.2 代码文档要求
   ### 5.3 代码实现原则（KISS、YAGNI、DRY、SOLID）
   ### 5.4 注释和回复语言
   ### 5.5 回复开场白
   ### 5.6 Skill 使用说明
   ### 5.7 shadcn/ui 组件安装
   ### 5.8 文档同步要求

## 6. 项目约定（30 行）
   ### 6.1 时间戳工具函数
   ### 6.2 其他约定

## 7. 文档参考（40 行）
   ### 7.1 架构相关文件
   ### 7.2 服务层文件
   ### 7.3 兼容层文件
   ### 7.4 工具函数文件
   ### 7.5 配置文件

附录：文件结构（10 行）
```

### 3.2 预计行数分配

| 章节 | 当前行数 | 精简后行数 | 减少比例 |
|------|----------|------------|----------|
| **文档维护原则（新增）** | 0 | 45 | - |
| 项目概述 | 25 | 5 | 80% |
| 架构 | 20 | 10 | 50% |
| 开发命令 | 32 | 20 | 37% |
| 测试辅助工具 | 250 | 0（移除） | 100% |
| 关键技术细节 | 22 | 0（移除） | 100% |
| 关键设计说明 | 400 | 80 | 80% |
| 跨平台兼容性 | 400 | 20 | 95% |
| 添加 Tauri 命令 | 5 | 0（移至文档参考） | 100% |
| 工具函数 | 40 | 0（移至项目约定） | 100% |
| 导入路径规范 | 18 | 保留 | 0% |
| 代码文档要求 | 44 | 保留 | 0% |
| 代码实现要求 | 50 | 保留 | 0% |
| 开发规范 | 100 | 保留 | 0% |
| 国际化 | 40 | 0（移至文档参考） | 100% |
| 文件结构 | 5 | 10（保留） | 0% |
| **文档参考（新增）** | 0 | 40 | - |
| **总计** | **1316** | **约 370** | **约 72%** |

---

## 4. 实施方案

### 4.1 实施步骤

#### 阶段 1：备份和准备
1. 备份当前 AGENTS.md 为 `AGENTS.md.backup`
2. 创建精简版本草稿 `AGENTS.md.draft`

#### 阶段 2：内容精简
1. **删除冗余内容**
   - 删除详细的代码示例（保留简要说明）
   - 删除重复的 HTTP 插件说明
   - 删除详细的测试统计

2. **重写关键章节**
   - 精简"关键设计说明"为架构概览
   - 精简"跨平台兼容性"为设计原则
   - 创建"文档参考"章节

3. **添加文档维护原则章节**（新增）
   - 在文档开头添加"文档维护原则"章节
   - 包含内容分类规则、检查清单、优先级原则、维护规范、当前文档状态
   - 确保未来文档更新遵循精简原则

4. **优化章节顺序**
   - 按重要性重新组织
   - 开发规范前置

#### 阶段 3：验证和测试
1. 检查所有文件引用路径正确性
2. 确保关键信息无遗漏
3. 验证文档可读性

#### 阶段 4：应用和归档
1. 用精简版本替换 AGENTS.md
2. 运行 `pnpm lint` 和 `pnpm tsc` 确保无影响
3. 更新相关文档（如有）

### 4.2 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 删除过多关键信息 | 高 | 保留备份，逐步验证 |
| 文档引用路径错误 | 中 | 运行 grep 验证路径存在性 |
| AI 助手适应新格式 | 中 | 保持开发规范章节完整 |
| 团队成员不适应 | 低 | 提供迁移指南 |

---

## 5. 文档参考章节设计

### 5.1 快速查找指南

**按功能查找文件**：

| 功能需求 | 文件路径 |
|---------|----------|
| 应用初始化配置 | `src/config/initSteps.ts` |
| 聊天服务 | `src/services/chatService.ts` |
| 远程模型数据获取 | `src/services/modelRemoteService.ts` |
| 跨平台兼容层 | `src/utils/tauriCompat/index.ts` |
| 主密钥管理 | `src/store/keyring/masterKey.ts` |
| 加密工具 | `src/utils/crypto.ts` |
| 时间戳工具 | `src/utils/utils.ts` |
| 测试辅助工具 | `src/__test__/helpers/` |
| 国际化配置 | `src/lib/i18n.ts` |

**按架构层次查找**：

```
├── 配置层
│   ├── src/config/initSteps.ts      # 初始化步骤配置
│   └── src/utils/constants.ts       # 常量定义
│
├── 服务层
│   ├── src/services/chatService.ts  # 聊天服务
│   └── src/services/modelRemoteService.ts  # 远程数据服务
│
├── 存储层
│   ├── src/store/keyring/           # 主密钥管理
│   ├── src/store/slices/            # Redux 状态管理
│   └── src/store/storage/           # 数据持久化
│
├── 兼容层
│   └── src/utils/tauriCompat/       # 跨平台兼容
│
├── 工具层
│   ├── src/utils/crypto.ts          # 加密工具
│   ├── src/utils/utils.ts           # 通用工具
│   └── src/lib/i18n.ts              # 国际化
│
└── 测试层
    └── src/__test__/helpers/        # 测试辅助工具
```

---

## 6. 示例对比

### 6.1 精简前示例（当前文档）

```markdown
### HTTP 插件 (`@/utils/tauriCompat/http.ts`)

- `fetch()`: 统一的 fetch 函数，根据环境自动选择实现
  - 开发环境：使用原生 Web `fetch` API（便于调试）
  - 生产环境 + Tauri 平台：使用 `@tauri-apps/plugin-http` 的 `fetch`（系统代理、证书管理）
  - 生产环境 + Web 平台：使用原生 Web `fetch` API
- `getFetchFunc()`: 获取 fetch 函数实例，用于第三方库注入或自定义封装
  - 适用于为第三方库（如 Axios）注入 fetch 函数
  - 适用于封装自定义的请求方法

**使用场景示例**：

```typescript
// 场景 1：直接使用 fetch（适用于常规 HTTP 请求）
import { fetch } from "@/utils/tauriCompat";

const response = await fetch("https://api.example.com/data");
const data = await response.json();

// 场景 2：使用 getFetchFunc 封装自定义请求方法或注入第三方库
import { getFetchFunc } from "@/utils/tauriCompat";
import axios from "axios";

// 自定义封装
class ApiClient {
  private fetch = getFetchFunc();

  async request(url: string, options?: RequestInit) {
    const response = await this.fetch(url, options);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  }
}

// 注入第三方库（如 Axios）
const api = axios.create({ adapter: getFetchFunc() });
const response = await api.get("https://api.example.com/data");
```

**环境判断逻辑**：

```
IF (开发模式: import.meta.env.DEV === true) THEN
  使用原生 Web fetch
ELSE IF (生产 Tauri 平台: window.__TAURI__ 存在) THEN
  使用 @tauri-apps/plugin-http 的 fetch
ELSE (生产 Web 平台)
  使用原生 Web fetch
```

**类型说明**：
- `RequestInfo`: 自定义类型定义，兼容 Web 和 Tauri fetch 的输入参数类型
- `FetchFunc`: fetch 函数类型
- 其他类型（RequestInit、Response、Headers、Request）：直接使用原生类型定义

**使用场景示例**：

```typescript
// 场景 1：直接使用 fetch（适用于常规 HTTP 请求）
import { fetch } from "@/utils/tauriCompat";

const response = await fetch("https://api.example.com/data");
const data = await response.json();

// 场景 2：使用 getFetchFunc 封装自定义请求方法或注入第三方库
import { getFetchFunc } from "@/utils/tauriCompat";
import axios from "axios";

// 自定义封装
class ApiClient {
  private fetch = getFetchFunc();

  async request(url: string, options?: RequestInit) {
    const response = await this.fetch(url, options);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  }
}

// 注入第三方库（如 Axios）
const api = axios.create({ adapter: getFetchFunc() });
const response = await api.get("https://api.example.com/data");
```
```

**问题**：
- 共 110 行
- "使用场景示例"重复 2 次
- 详细代码示例可在源文件中查看

### 6.2 精简后示例（新文档）

```markdown
#### HTTP 插件兼容层 (`src/utils/tauriCompat/http.ts`)

统一的 fetch 函数，根据环境自动选择实现：
- 开发环境：原生 Web `fetch`（便于调试）
- 生产 Tauri：`@tauri-apps/plugin-http` 的 `fetch`（系统代理、证书管理）
- 生产 Web：原生 Web `fetch`

**环境判断逻辑**：
```
开发模式 → 原生 fetch
生产 Tauri → Tauri fetch
生产 Web → 原生 fetch
```

**详细实现**：见 `src/utils/tauriCompat/http.ts`
```

**改进**：
- 共 15 行（减少 86%）
- 删除重复的代码示例
- 保留核心逻辑说明
- 提供文件引用

---

## 7. 后续维护建议

### 7.1 文档维护原则

1. **保持精简**：只保留无法从代码中直接获取的信息
2. **及时更新**：架构变更时同步更新文档
3. **定期审查**：每季度检查一次文档是否有过时内容
4. **版本控制**：重大变更前备份当前版本
5. **正面描述规范**：描述要求时使用正面描述（"要干xxx"），避免反面描述（"不要干xxx"）
   - 示例：使用"始终使用 `@/` 别名导入"，而非"不要使用相对路径"
   - 示例：使用"函数参数注释使用 JSDoc 格式"，而非"不要使用非标准格式"

### 7.2 添加新内容时的检查清单

在 AGENTS.md 中添加新内容前，先确认：

- [ ] 该信息是否无法从代码中查询？
- [ ] 是否符合文档结构（是否有更合适的章节）？
- [ ] 是否包含冗余的代码示例？
- [ ] 是否与已有内容重复？
- [ ] 是否提供了文件引用（如有必要）？
- [ ] 是否使用正面描述（"要干xxx"而非"不要干xxx"）？

### 7.3 代码注释优先原则

对于实现细节：
- **优先**：在代码中添加详细注释
- **其次**：在 README.md 中添加使用说明
- **最后**：在 AGENTS.md 中添加架构说明

---

## 8. 成功标准

### 8.1 定量指标

- [ ] 文档行数从 1316 行减少至 350 行以内
- [ ] 删除至少 200 行重复内容
- [ ] 删除至少 150 行详细代码示例
- [ ] 新增文档参考章节（40 行以内）

### 8.2 定性指标

- [ ] 关键架构信息完整保留
- [ ] 开发规范章节完整保留
- [ ] 所有文件引用路径正确
- [ ] 文档可读性提升（通过 3 人以上验证）
- [ ] AI 助手能正常理解和使用精简后的文档

### 8.3 验收测试

1. **完整性检查**：grep 验证所有引用的文件存在
2. **可读性检查**：邀请 2-3 名开发者阅读并反馈
3. **功能验证**：使用精简后的 AGENTS.md 进行一次完整开发任务
4. **回归测试**：确保不破坏现有开发流程

---

## 9. 回滚方案

如果精简后的文档导致问题：

1. **立即回滚**：恢复 `AGENTS.md.backup`
2. **分析原因**：收集反馈，识别问题
3. **调整方案**：根据反馈修改精简策略
4. **重新实施**：采用更保守的精简方案

---

## 10. 附录：精简前后对比

### 10.1 章节对比

| 章节 | 精简前 | 精简后 | 变化 |
|------|--------|--------|------|
| 项目概述 | 25 行 | 5 行 | -80% |
| 架构 | 20 行 | 10 行 | -50% |
| 开发命令 | 32 行 | 20 行 | -37% |
| 测试辅助工具 | 250 行 | 0 行 | -100% |
| 关键技术细节 | 22 行 | 0 行 | -100% |
| 关键设计说明 | 400 行 | 80 行 | -80% |
| 跨平台兼容性 | 400 行 | 20 行 | -95% |
| 开发规范 | 100 行 | 100 行 | 0% |
| 文档参考 | 0 行 | 40 行 | +40 行 |
| 其他 | 67 行 | 50 行 | -25% |
| **总计** | **1316 行** | **325 行** | **-75%** |

### 10.2 关键变化

**删除内容**：
- ❌ 250 行测试辅助工具详细说明
- ❌ 200 行详细代码示例
- ❌ 150 行测试覆盖率统计
- ❌ 100 行重复的 HTTP 插件说明

**保留内容**：
- ✅ 所有开发规范（100 行）
- ✅ 项目架构概览（15 行）
- ✅ 关键设计说明（80 行）

**新增内容**：
- ➕ 文档参考章节（40 行）
- ➕ 快速查找指南
- ➕ 架构层次索引

---

## 结论

通过精简 AGENTS.md，我们可以：
1. **减少 75% 的文档行数**（1316 → 325 行）
2. **提升可维护性**（减少重复内容）
3. **提升可读性**（突出关键信息）
4. **保持完整性**（所有必要信息保留或可引用）

精简后的文档将更加聚焦于**架构指导**和**开发规范**，而将**实现细节**交给代码注释和类型定义。
