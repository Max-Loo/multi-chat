# 提案：为关键 UI 组件添加测试

## Why

当前项目的整体测试覆盖率为 32.75%，其中 UI 组件层的覆盖率严重不足。核心业务逻辑（加密、存储、密钥管理）已有完善的测试保障（90%+ 覆盖率），但用户直接交互的关键 UI 组件（侧边栏、聊天页面、设置页面）几乎无测试覆盖，这增加了回归风险和重构难度。在引入 Playwright 端到端测试之前，需要先建立 UI 组件单元测试的基础保障，确保核心交互路径的稳定性。

## What Changes

为以下关键 UI 组件添加单元测试：

- **侧边栏导航组件** (`src/components/Sidebar/index.tsx`)
  - 测试聊天列表渲染
  - 测试新建聊天功能
  - 测试聊天项选择和删除交互
  - 测试搜索过滤功能

- **聊天页面组件** (`src/pages/Chat/ChatPage.tsx`)
  - 在现有 7 个测试基础上增强
  - 补充流式消息接收测试
  - 补充消息重试和错误处理测试
  - 补充推理内容显示测试

- **设置页面相关组件** (`src/pages/Setting/`)
  - 模型配置界面测试
  - 语言切换测试
  - 主题切换测试
  - API Key 配置测试

**目标**：将这些组件的测试覆盖率提升到 60-70%，确保核心交互路径有基本保障。

## Capabilities

### New Capabilities

- **sidebar-component-tests**: 侧边栏导航组件的单元测试，包括聊天列表管理、新建聊天、聊天项交互（选择、删除）、搜索过滤等核心功能。

- **chat-page-tests**: 聊天页面的单元测试增强，覆盖流式消息接收、错误处理、消息重试、推理内容显示等核心用户交互流程。

- **settings-page-tests**: 设置页面的单元测试，包括模型配置、应用设置（语言、主题）、API Key 管理等功能。

### Modified Capabilities

无现有能力的需求变更。此次变更仅新增测试，不改变现有功能规范。

## Impact

**受影响的代码**：
- `src/components/Sidebar/` - 侧边栏组件（当前覆盖率 0%）
- `src/pages/Chat/ChatPage.tsx` - 聊天页面（需在现有测试基础上增强）
- `src/pages/Setting/` - 设置页面相关组件（当前覆盖率较低）

**新增依赖**：
- 无新增运行时依赖（仅使用现有测试框架：Vitest + Testing Library）

**测试框架**：
- 使用 Vitest 作为测试运行器（已配置）
- 使用 @testing-library/react 进行组件测试（已安装）
- 使用项目现有的测试辅助工具（`@/test-helpers`）

**CI/CD 影响**：
- 测试套件将增加 40-60 个新测试用例
- 预计测试运行时间增加 10-20 秒
- 所有新测试必须通过才能合并代码

**文档影响**：
- 更新 AGENTS.md 中的测试覆盖率统计
- 可能需要添加 UI 组件测试最佳实践文档

**后续依赖**：
- 此变更为引入 Playwright 端到端测试奠定基础
- 提升的单元测试覆盖率将降低 E2E 测试的调试成本
