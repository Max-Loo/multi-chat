## Context

当前聊天服务（`chatService.ts`）使用 Vercel AI SDK 与多个模型供应商（DeepSeek、Moonshot、Zhipu）通信。在 `buildMessages` 函数中，历史消息被转换为 AI SDK 格式时仅包含 `content` 字段。

随着推理模型（如 DeepSeek R1）的普及，这些模型会生成 `reasoningContent`（推理过程内容）。目前这部分内容在后续对话中丢失，导致模型无法访问之前的推理上下文，可能影响响应质量和连贯性。

**约束条件**：
- 必须保持向后兼容，不影响现有功能
- 消息格式必须符合所有供应商的 API 要求
- 不能破坏不支持推理内容的模型的行为

## Goals / Non-Goals

**Goals:**
- 在历史消息中包含 `reasoningContent`，使模型能够访问完整的推理上下文
- 提供用户控制的切换按钮，让用户自主决定是否传输推理内容
- 确保实现对所有模型供应商透明且兼容
- 最小化 token 使用量的影响（默认未选中，用户按需开启）

**Non-Goals:**
- 修改推理内容的生成方式（由模型和供应商决定）
- 在 UI 中单独显示历史推理内容（UI 改进不在范围）
- 修改消息存储结构（仅影响发送给模型的内容）
- 全局默认开启传输推理内容（由用户主动选择）

## Decisions

### 决策 1：推理内容格式 - 使用 AI SDK 原生 reasoning part

**选择**：使用 Vercel AI SDK 的原生 `reasoning` part 类型（`type: 'reasoning'`）作为 assistant 消息 content 数组中的独立元素。

**理由**：
- **标准化**：这是 Vercel AI SDK 官方支持的处理推理内容的标准方式
- **兼容性**：所有使用 AI SDK 的供应商（DeepSeek、Moonshot、Zhipu）都自动支持此格式
- **维护性**：SDK 自动处理推理内容的序列化和传输，无需手动字符串操作
- **面向未来**：跟随 AI SDK 的演进，自动获得未来的优化和功能
- **类型安全**：TypeScript 类型系统完整支持，编译时即可捕获错误

**实现方式**：
```typescript
// assistant 消息的 content 数组包含多个 part
const parts: AssistantContent = [
  { type: 'text', text: baseContent },           // 原始回复内容
  { type: 'reasoning', text: reasoningContent }, // 推理内容（可选）
];

return {
  role: 'assistant',
  content: parts,
};
```

**替代方案**：
- 将推理内容追加到 `content` 字段并用 XML 标签包裹：需要手动字符串操作，容易出错
- 使用单独的自定义字段：不符合 AI SDK 标准，可能不被供应商支持
- 仅发送推理内容：会丢失原始内容，不完整

### 决策 2：仅对助手消息应用

**选择**：只为 `role: 'assistant'` 的消息添加推理内容。

**理由**：
- **准确性**：只有助手消息才包含 `reasoningContent`，用户消息不需要
- **效率**：避免不必要的处理和 token 消耗
- **语义正确**：推理内容是模型的思考过程，与助手角色对应

### 决策 3：UI 切换按钮控制 - 用户可选择是否传输

**选择**：在聊天界面添加切换按钮，让用户控制是否传输历史推理内容。默认未选中。

**按钮样式设计**（参考现代 UI 设计规范）：
- 采用描边样式（outline variant），简洁的圆角矩形按钮
- 尺寸：高度 32px（`h-8`），圆角 6px（`rounded-md`），左右内边距 12px（`px-3`）
- 未选中状态：
  - 边框：浅灰色（`border-gray-300`）
  - 文字：中等灰色（`text-gray-500`）
  - 背景：纯白色（`bg-white`）
  - 悬停：边框变深（`hover:border-gray-400`），文字变深（`hover:text-gray-700`）
- 选中状态：
  - 边框：蓝色（`border-blue-500`）
  - 文字：蓝色（`text-blue-500`）
  - 背景：浅蓝色（`bg-blue-50`）
  - 悬停：背景稍深（`hover:bg-blue-100`）

**理由**：
- **用户控制**：让用户自主决定是否需要额外的上下文，平衡质量和成本
- **渐进式增强**：默认未选中保证基础体验，有需求的用户可主动选中
- **降低成本**：避免所有用户都承担额外的 token 消耗
- **灵活性**：不同场景下用户可以选择是否需要推理上下文
- **视觉清晰**：通过蓝色主题色突出选中状态，与 Sidebar 导航按钮保持一致的设计语言
- **现代设计**：扁平化风格，无阴影，符合当代 UI 设计趋势

**替代方案**：
- 默认开启：增加所有用户的 token 消耗，可能引起不满
- 按模型自动判断：逻辑复杂，无法准确判断用户意图
- 后端全局配置：无法满足不同用户的个性化需求

### 决策 4：状态持久化 - 本地存储按钮状态

**选择**：使用 Redux store 管理按钮状态，并持久化到 localStorage。

**理由**：
- **用户体验**：记住用户的偏好设置，无需每次会话都重新选择
- **简单可靠**：使用现有的状态管理和存储机制，无需额外依赖
- **响应性**：Redux store 提供响应式状态更新，UI 可实时响应按钮状态变化

**替代方案**：
- Session storage：状态在关闭标签页后丢失
- 后端存储：增加服务器复杂度，且此设置属于 UI 偏好而非数据
- 仅运行时状态：用户需要频繁开关，体验不佳

## Risks / Trade-offs

### Risk 1：Token 使用量显著增加
**风险**：当按钮选中时，长对话中历史推理内容累积可能导致每次请求的 token 数量大幅增加。

**缓解措施**：
- **默认未选中**：按钮默认未选中，避免所有用户承担额外成本
- **用户控制**：用户可根据需要点击按钮，灵活管理 token 使用
- 仅在 `reasoningContent` 非空且按钮选中时才添加
- 用户可通过控制历史消息长度来管理 token 使用

### Risk 2：模型对推理格式的误解
**风险**：某些模型可能将 `<reasoning>` 标签解释为需要执行的指令。

**缓解措施**：
- 使用温和的标签格式，避免指令性语言
- 在实际部署后监控模型响应质量
- 如有问题，可调整标签格式（如使用更中性的分隔符）

### Risk 3：不同供应商的兼容性问题
**风险**：某些供应商 API 可能不支持长内容或特定格式。

**缓解措施**：
- 所有供应商（DeepSeek、Moonshot、Zhipu）都支持长文本内容
- 保留原始 `content` 字段，推理内容为追加性质，不破坏基本功能
- 可通过功能标志（feature flag）按供应商启用/禁用

## Migration Plan

**部署步骤**：
1. 添加 Redux slice 管理开关状态
2. 在聊天页面添加开关 UI 组件
3. 修改 `buildMessages` 函数，添加开关参数
4. 更新 `streamChatCompletion` 函数，传递开关状态
5. 在开发环境测试各供应商的兼容性和 UI 交互
6. 监控 token 使用量和响应延迟
7. 逐步推送到生产环境

**回滚策略**：
- 保留原始代码路径，通过简单的代码回滚即可恢复
- UI 开关默认关闭，回滚时用户感知最小
- 无数据库迁移或配置变更，回滚风险低

## Open Questions

无
