# Tasks: crypto.ts 集成测试

## 1. 测试文件创建

- [x] 1.1 创建集成测试目录 `src/__test__/integration/`
- [x] 1.2 创建测试文件 `src/__test__/integration/crypto-storage.integration.test.ts`
- [x] 1.3 在测试文件顶部添加描述注释（测试目的、范围、Mock 策略）

## 2. 端到端加密存储流程测试

- [x] 2.1.1 实现测试用例：首次启动生成新密钥并加密
- [x] 2.1.2 实现测试用例：已有密钥时复用并加密
- [x] 2.1.3 验证 `encryptField()` 被调用且密文以 `enc:` 开头
- [x] 2.1.4 验证 `setPassword()` 被调用一次（首次启动）或未被调用（已有密钥）

### 2.2 加载模型时自动解密敏感字段

- [x] 2.2.1 实现测试用例：使用初始化密钥进行往返加密/解密
- [x] 2.2.2 验证 `getPassword()` 被调用
- [x] 2.2.3 验证 `decryptField()` 被调用且返回原始明文
- [x] 2.2.4 验证数据完整性（往返一致）

### 2.3 批量处理多个模型

- [x] 2.3.1 实现测试用例：并发加密 10 个模型
- [x] 2.3.2 验证所有密文互不相同（nonce 唯一性）
- [x] 2.3.3 验证性能：10 个模型加密/解密 < 1 秒

## 3. 解密失败场景测试

- [x] 3.1.1 实现测试用例：模拟 10 个模型，2 个使用旧密钥
- [x] 3.1.2 Mock `decryptField()` 对旧密钥模型抛出错误
- [x] 3.1.3 验证 8 个模型解密成功，2 个模型 `apiKey` 为空字符串
- [x] 3.1.4 验证错误被记录到 `console.error`

### 3.2 解密失败不应中断批量操作

- [x] 3.2.1 实现测试用例：所有模型都使用旧密钥
- [x] 3.2.2 验证系统返回空 `apiKey` 的模型列表
- [x] 3.2.3 验证系统不抛出异常（优雅降级）

## 4. 主密钥丢失后的数据访问测试

### 4.1 主密钥不存在时加载模型

- [x] 4.1.1 实现测试用例：`getPassword()` 返回 `null`
- [x] 4.1.2 Mock 已存储的模型列表包含加密的 `apiKey`
- [x] 4.1.3 验证加密的 `apiKey` 被替换为空字符串
- [x] 4.1.4 验证未加密的 `apiKey` 保持不变
- [x] 4.1.5 验证警告被记录到 `console.warn`

### 4.2 未加密的 apiKey 保持不变

- [x] 4.2.1 实现测试用例：混合加密/未加密的 `apiKey`
- [x] 4.2.2 验证未加密的 `apiKey` 不被修改为空字符串

## 5. 并发加密场景的密文唯一性测试

- [x] 5.1 实现测试用例：并发加密 100 个相同明文
- [x] 5.2 验证所有 100 个密文互不相同（`Set.size === 100`）
- [x] 5.3 验证所有 100 个密文能成功解密
- [x] 5.4 验证性能：100 次加密 < 5 秒

## 6. 混合数据完整性测试

### 6.1 保存混合加密状态的模型

- [x] 6.1.1 实现测试用例：4 个模型（未加密、已加密、空、undefined）
- [x] 6.1.2 验证仅未加密的 `apiKey` 被加密
- [x] 6.1.3 验证已加密的 `apiKey` 不被重复加密
- [x] 6.1.4 验证空和 undefined 值保持不变

### 6.2 加载混合加密状态的模型

- [x] 6.2.1 实现测试用例：混合加密/未加密的模型列表
- [x] 6.2.2 验证加密的 `apiKey` 被解密
- [x] 6.2.3 验证未加密的 `apiKey` 保持不变

## 7. 密钥长度严格验证测试

- [x] 7.1 实现测试用例：接受 64 个 hex 字符的密钥
- [x] 7.2 验证密钥被转换为 32 字节（256-bit）
- [x] 7.3 实现测试用例：拒绝空密钥（抛出"密钥不能为空"）
- [x] 7.4 验证 `hexToBytes()` 被调用且验证 hex 格式

## 8. Nonce 随机性和唯一性测试

- [x] 8.1 实现测试用例：每次加密生成不同的 nonce
- [x] 8.2 验证 nonce 为 12 字节
- [x] 8.3 验证 `crypto.getRandomValues()` 被调用
- [x] 8.4 实现测试用例：100 次加密产生 100 个不同 nonce
- [x] 8.5 验证所有 100 个密文互不相同

## 9. 恶意密文格式防御测试

- [x] 9.1.1 实现测试用例：`enc:!!!@#$%`
- [x] 9.1.2 验证 `base64ToBytes()` 抛出错误
- [x] 9.1.3 验证系统捕获错误并包装为用户友好消息

### 9.2 拒绝不完整的密文

- [x] 9.2.1 实现测试用例：有效的 Base64 但解码后少于 12 字节
- [x] 9.2.2 验证系统检测到数据长度不足
- [x] 9.2.3 验证系统抛出"无效的加密数据格式：数据长度不足"

### 9.3 isEncrypted() 对恶意输入的防御

- [x] 9.3.1 实现测试用例：恶意输入（XSS 尝试、二进制数据、超长数据）
- [x] 9.3.2 验证 `isEncrypted()` 返回 `true`（只要以 `enc:` 开头）
- [x] 9.3.3 验证系统不崩溃或抛出异常
- [x] 9.3.4 验证后续解密操作优雅失败

### 9.4 修改密文后验证失败

- [x] 9.4.1 实现测试用例：修改密文字节（翻转位）
- [x] 9.4.2 验证解密失败（AES-GCM 认证标签验证）
- [x] 9.4.3 验证错误消息为"解密敏感数据失败，可能是主密钥已更改或数据已损坏"

## 10. 测试文档和注释

- [x] 10.1 在测试文件顶部添加描述注释（测试目的、范围、Mock 策略）
- [x] 10.2 使用描述性测试名称（如"应生成并存储新密钥并加密"）
- [x] 10.3 为关键断言添加清晰的消息（`expect(decrypted, '解密结果应与原始明文一致')`）
- [x] 10.4 添加测试分组注释（使用 `describe` 和 `test` 组织结构）

## 11. 测试验证

- [x] 11.1 运行 `pnpm test:run` 验证所有测试通过
- [x] 11.2 运行 `pnpm test:coverage` 验证覆盖率达标
- [x] 11.3 验证测试时间增加 < 5 秒（新增 26 个测试用例）
- [x] 11.4 验证现有测试不被破坏（`crypto.test.ts`, `crypto-masterkey.integration.test.ts`）

## 12. 边缘用例和错误路径测试

- [x] 12.1 测试无效 hex 字符串的密钥
- [x] 12.2 测试奇数长度 hex 字符串的密钥
- [x] 12.3 测试缺少 enc: 前缀的解密
- [x] 12.4 测试 isEncrypted() 对各种输入的判断
