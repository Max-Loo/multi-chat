# Crypto 模块测试优化实现任务

## 1. 源代码修改

- [x] 1.1 在 `src/utils/crypto.ts` 中导出 `hexToBytes` 函数
- [x] 1.2 在 `src/utils/crypto.ts` 中导出 `bytesToBase64` 函数
- [x] 1.3 在 `src/utils/crypto.ts` 中导出 `base64ToBytes` 函数
- [x] 1.4 为三个导出的内部函数添加 `@internal` JSDoc 注释
- [x] 1.5 运行 `pnpm tsc` 确保类型检查通过

## 2. 测试文件准备

- [x] 2.1 在 `src/__test__/utils/crypto.test.ts` 中导入新导出的函数
- [x] 2.2 添加测试辅助函数和常量（如测试数据常量）
- [x] 2.3 组织测试文件结构（使用 `describe` 嵌套）

## 3. 内部工具函数测试（crypto-utils-coverage）

### 3.1 hexToBytes 函数测试

- [x] 3.1.1 添加正常转换测试：偶数长度 hex 字符串
- [x] 3.1.2 添加边界测试：空字符串转换
- [x] 3.1.3 添加异常测试：奇数长度 hex 字符串
- [x] 3.1.4 添加异常测试：包含非 hex 字符（如 "ghij"）
- [x] 3.1.5 添加正常测试：大小写混合 hex 字符串

### 3.2 bytesToBase64 函数测试

- [x] 3.2.1 添加正常转换测试：标准字节数组
- [x] 3.2.2 添加边界测试：空数组
- [x] 3.2.3 添加正常测试：包含所有 256 种字节值（0-255）
- [x] 3.2.4 添加正常测试：包含不可打印字符的字节数组

### 3.3 base64ToBytes 函数测试

- [x] 3.3.1 添加正常转换测试：标准 Base64 字符串
- [x] 3.3.2 添加正常测试：无填充字符的 Base64
- [x] 3.3.3 添加异常测试：无效 Base64 字符串
- [x] 3.3.4 添加边界测试：空字符串

### 3.4 转换往返测试

- [x] 3.4.1 添加 hex → bytes → hex 往返测试
- [x] 3.4.2 添加 bytes → Base64 → bytes 往返测试
- [x] 3.4.3 添加完整往返测试：hex → bytes → Base64 → bytes → hex

## 4. 输入验证测试（crypto-validation-tests）

### 4.1 encryptField 密钥格式验证

- [x] 4.1.1 添加有效密钥测试：64 字符 hex 字符串
- [x] 4.1.2 添加无效密钥测试：非 64 字符长度（使用 `test.each` 参数化）
- [x] 4.1.3 添加无效密钥测试：包含非 hex 字符
- [x] 4.1.4 添加无效密钥测试：空字符串

### 4.2 encryptField 明文输入验证

- [x] 4.2.1 添加正常明文测试：标准 ASCII 字符串
- [x] 4.2.2 添加边界测试：空字符串
- [x] 4.2.3 添加 Unicode 测试：中文、emoji 等字符
- [x] 4.2.4 添加性能测试：超长字符串（> 1MB）
- [x] 4.3.1 添加有效密文测试：标准 `enc:` 格式
- [x] 4.3.2 添加异常测试：缺少 `enc:` 前缀
- [x] 4.3.3 添加异常测试：`enc:` 后无数据
- [x] 4.3.4 添加异常测试：无效的 Base64 数据
- [x] 4.4.1 添加有效密文测试：正确的 nonce 长度（12 字节）
- [x] 4.4.2 添加异常测试：数据长度不足（≤ 12 字节）
- [x] 4.4.3 添加异常测试：密文部分为空（只有 nonce）
- [x] 4.5.1 添加错误密钥测试：不同的 64 字符 hex 字符串
- [x] 4.5.2 添加错误密钥测试：相似但不同的密钥
- [x] 4.6.1 添加已加密测试：标准 `enc:` 前缀
- [x] 4.6.2 添加未加密测试：无 `enc:` 前缀
- [x] 4.6.3 添加边界测试：空字符串
- [x] 4.6.4 添加边界测试：只有部分前缀（如 "enc", "en:"）

## 5. 边界条件测试（crypto-edge-cases）

### 5.1 大数据量测试

- [x] 5.1.1 添加超长文本加密解密测试（> 1MB）
- [x] 5.1.2 添加性能验证：操作应在合理时间内完成
- [x] 5.1.3 添加 nonce 唯一性测试：相同明文多次加密产生不同密文

### 5.2 特殊 Unicode 字符处理

- [x] 5.2.1 添加 CJK 字符测试：中文、日文、韩文
- [x] 5.2.2 添加 emoji 测试：各种 emoji 字符
- [x] 5.2.3 添加组合字符测试：带变音符号的字符
- [x] 5.2.4 添加双向文本测试：从左到右和从右到左混合

### 5.3 特殊 ASCII 字符处理

- [x] 5.3.1 添加控制字符测试：换行符、制表符、回车符
- [x] 5.3.2 添加多行文本测试
- [x] 5.3.3 添加特殊符号测试：!@#$%^&*() 等
- [x] 5.3.4 添加零字符测试：包含 `\0` 的文本

### 5.4 密钥边界情况测试

- [x] 5.4.1 添加最小有效长度测试：正好 64 个 hex 字符
- [x] 5.4.2 添加边界测试：所有位为 0 的密钥
- [x] 5.4.3 添加边界测试：所有位为 f 的密钥
- [x] 5.4.4 添加正常测试：大小写混合的密钥

### 5.5 密文边界情况测试

- [x] 5.5.1 添加最小有效密文测试：加密空字符串
- [x] 5.5.2 添加异常测试：非 Base64 字符在 `enc:` 后
- [x] 5.5.3 添加异常测试：截断的 Base64 数据

### 5.6 加密算法特性测试

- [x] 5.6.1 添加认证标签验证测试：修改密文字节应导致解密失败
- [x] 5.6.2 添加 nonce 验证测试：检查每次加密的 nonce 不同
- [x] 5.6.3 添加密钥重用安全测试：相同密钥加密不同明文

### 5.7 性能边界测试

- [x] 5.7.1 添加性能测试：单个字符加密解密
- [x] 5.7.2 添加性能测试：中等文本（10KB）
- [x] 5.7.3 添加性能测试：连续 1000 次加密/解密操作
- [x] 5.7.4 添加内存测试：确保无内存泄漏

### 5.8 并发和异步测试

- [x] 5.8.1 添加并发测试：同时启动多个加密操作
- [x] 5.8.2 添加异步测试：加密和解密在不同事件循环中执行

## 6. 代码质量改进

- [x] 6.1 使用 `test.each()` 参数化测试减少重复代码
- [x] 6.2 创建测试辅助函数（如 `testInvalidInput`）
- [x] 6.3 为测试用例添加清晰的描述性名称
- [x] 6.4 确保 `describe` 嵌套层次清晰

## 7. 验证和测试

- [x] 7.1 运行 `pnpm test:run` 确保所有测试通过
- [x] 7.2 运行 `pnpm test:coverage` 生成覆盖率报告
- [x] 7.3 验证代码覆盖率达到 100%
- [x] 7.4 运行 `pnpm tsc` 确保无类型错误
- [x] 7.5 运行 `pnpm lint` 确保代码符合规范
- [x] 7.6 手动审查测试代码的可读性和可维护性
- [x] 7.7 确认所有测试用例都能独立运行（无相互依赖）

## 8. 文档和清理

- [x] 8.1 更新测试文件顶部的文档注释（如有）
- [x] 8.2 移除调试代码和 console.log
- [x] 8.3 确保 `@internal` 注释清晰说明导出目的
- [x] 8.4 提交代码前进行最终代码审查
